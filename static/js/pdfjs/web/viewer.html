<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>قارئ PDF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind للـ UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Cairo', sans-serif; background-color: #0f172a; color: #f8fafc; margin:0; }
    iframe { border:none; }
  </style>
</head>
<body class="flex flex-col h-screen">

  <!-- Toolbar -->
  <div class="flex justify-between items-center bg-white/10 backdrop-blur px-4 py-2 border-b border-white/10">
    <div class="flex items-center gap-3">
      <button id="prevPage" class="px-3 py-1 rounded bg-indigo-500 hover:bg-indigo-400">⬅ الصفحة السابقة</button>
      <button id="nextPage" class="px-3 py-1 rounded bg-indigo-500 hover:bg-indigo-400">الصفحة التالية ➡</button>
      <span class="ml-2" id="pageIndicator">1 / 1</span>
    </div>
    <a id="downloadLink" class="px-3 py-1 rounded bg-emerald-500 hover:bg-emerald-400" download>⬇ تحميل PDF</a>
  </div>

  <!-- Canvas للعرض -->
  <div class="flex-1 overflow-auto bg-slate-900 flex justify-center items-start p-4">
    <canvas id="pdf-render" class="rounded-lg shadow-lg"></canvas>
  </div>

  <!-- PDF.js -->
  <script src="{% static 'pdfjs/build/pdf.js' %}"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const url = urlParams.get('file'); // رابط PDF من Django
    if (!url) {
      alert("لا يوجد ملف PDF للعرض!");
    }

    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = "{% static 'pdfjs/build/pdf.worker.js' %}";

    let pdfDoc = null, pageNum = 1, pageIsRendering = false, pageNumIsPending = null;
    const scale = 1.2;
    const canvas = document.getElementById('pdf-render');
    const ctx = canvas.getContext('2d');

    const renderPage = num => {
      pageIsRendering = true;
      pdfDoc.getPage(num).then(page => {
        const viewport = page.getViewport({scale});
        canvas.height = viewport.height;
        canvas.width = viewport.width;

        const renderCtx = { canvasContext: ctx, viewport };
        const renderTask = page.render(renderCtx);

        renderTask.promise.then(() => {
          pageIsRendering = false;
          document.getElementById('pageIndicator').textContent = `${pageNum} / ${pdfDoc.numPages}`;
          if (pageNumIsPending !== null) {
            renderPage(pageNumIsPending);
            pageNumIsPending = null;
          }
        });
      });
    }

    const queueRenderPage = num => {
      if (pageIsRendering) pageNumIsPending = num;
      else renderPage(num);
    }

    const showPrevPage = () => {
      if (pageNum <= 1) return;
      pageNum--;
      queueRenderPage(pageNum);
    }

    const showNextPage = () => {
      if (pageNum >= pdfDoc.numPages) return;
      pageNum++;
      queueRenderPage(pageNum);
    }

    // Load PDF
    pdfjsLib.getDocument(url).promise.then(pdfDoc_ => {
      pdfDoc = pdfDoc_;
      document.getElementById('pageIndicator').textContent = `1 / ${pdfDoc.numPages}`;
      renderPage(pageNum);
      document.getElementById('downloadLink').href = url;
    }).catch(err => alert("خطأ في تحميل الملف PDF! " + err));

    // Buttons
    document.getElementById('prevPage').addEventListener('click', showPrevPage);
    document.getElementById('nextPage').addEventListener('click', showNextPage);
  </script>
</body>
</html>
